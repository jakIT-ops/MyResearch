## Braintree Overview

### Introduction to Braintree

[Braintree](https://www.braintreepayments.com/) is a full-stack payment platform. It allows you to accept online payments from customers in your application or website. The benefit of using Braintree is that it provides you with all services in one place, eliminating the need to separately set up payment gateways and merchant accounts.

Braintree is owned by PayPal. It offers many products such as Braintree Direct, Braintree Extend, Braintree Marketplace, etc. Each product offers a different set of tools and services.

### Braintree Direct

The product we are interested in for this course is [Braintree Direct](https://www.braintreepayments.com/products/braintree-direct). It consists of a set of tools that accept, verify, and process different payment methods. In other words, Braintree Direct consists of Software Development Kits (SDKs) for both the clients and servers.

* The client SDK provides tools and techniques to securely collect payment information supplied by the customer.

* The server SDK consists of tools to enable secure processing of the collected payment information.

### Braintree workflow

The step-by-step interaction between our client, server, and the Braintree server for creating a transaction is demonstrated below:

1. Our front-end requests a client token from our server and initializes the client SDK.

2. Our server generates a client token and sends it back to our client using the server SDK.

3. The customer submits payment information. The client SDK communicates that information to Braintree and returns a payment method nonce.

4. Our front-end sends the payment method nonce to our server.

5. Our server receives the payment method nonce and then uses the server SDK to create a transaction.

# 1. Braintree Setup

## 1.1 Client Setup for Braintree

Braintree provides us with different client-side SDKs such as Android, iOS, and JavaScript. These SDKs allow us to integrate Braintree functionality at the front-end of our applications.

The workflow of the events performed by our client using the Braintree SDK is shown below:

1. Token request sent to the server

2. Client token received from the server

3. Payment information sent to Braintree to get a payment method nonce

4. Payment method nonce received from Braintree

5. Payment method nonce sent to the server

### Drop-in UI

[Drop-in UI](https://developer.paypal.com/braintree/docs/start/drop-in) is a complete and ready-made payment UI provided by Braintree that offers a quick and easy way to securely accept payments. The UI includes a card entry form and, if enabled, PayPal, Venmo, Apple Pay, and Google Pay buttons. When a user successfully completes the UI, your client code obtains a payment method nonce for use on your server.

Drop-in UI provides us with the following benefits:

* <b>Quick and easy integrations:</b> Quickly integrate the Drop-in UI into the checkout flow of your app or website.

* <b>User-friendly and customizable UI</b>: Customize the checkout form to meet your needs, and fit your brand requirements.

* <b>Accept PayPal, cards, and more</b>: Easily add new payment methods to your form.

To add Drop-in UI to your page, you need to perform the following two steps:

1. Add an empty container to your page. We have added one on line 6.

2. Create a Drop-in instance using that container (or a string that functions as a query selector such as `#dropin-container`). We have used the `braintree.dropin.create` method in lines 9–13 to create a Drop-in instance.

`Drop-in UI setup`

```html
<head>
  <meta charset="utf-8">
  <script src="https://js.braintreegateway.com/web/dropin/1.29.0/js/dropin.min.js"></script>
</head>
<body>
  <div id="dropin-container"></div>

  <script type="text/javascript">
    braintree.dropin.create({
      container: '#dropin-container'
    }, (error, dropinInstance) => {
      // Use `dropinInstance` here  
    });
  </script>
</body>
```

### Get a client token

First of all, our client SDK needs a token generated by our server. The client can request this token using a GET request to our server. The server generates this token using the Braintree SDK and sends it back to our client. We will learn about generating and sending the client token from the server in the next lesson.

After receiving the client token, we embed it into our template by updating the `authorization` parameter of the`braintree.dropin.create` method as shown on line 10 in the webpage below.

`Embedding the client token`:

```html
<head>
  <meta charset="utf-8">
  <script src="https://js.braintreegateway.com/web/dropin/1.29.0/js/dropin.min.js"></script>
</head>
<body>
  <div id="dropin-container"></div>

  <script type="text/javascript">
    braintree.dropin.create({
      authorization: CLIENT_TOKEN_FROM_SERVER,
      container: '#dropin-container'
    }, (error, dropinInstance) => {
      // Use `dropinInstance` here          
    });
  </script>
</body>
```

### Request payment method nonce from Braintree

In the webpage below, we have created a `form` in lines 6–9 and put the empty container (line 7) that we plan to pass to `braintree.dropin.create` inside that form. This makes the layout and flow easier to manage. We have also added a `submit` button inside this form (line 8).

We called `dropinInstance.requestPaymentMethod()` on line 23 inside the click event handler of the `submit` button. Once the customer clicks this button, the client SDK sends the payment information (e.g., card number and expiration date) to Braintree in exchange for a payment method nonce. The payment method nonce is a one-time use-value that represents that particular payment method.

`Requesting the payment method nonce:`

```html
<head>
  <meta charset="utf-8">
  <script src="https://js.braintreegateway.com/web/dropin/1.29.0/js/dropin.min.js"></script>
</head>
<body>
  <form id="payment-form" action="/route/on/your/server" method="post">
    <div id="dropin-container"></div>
    <input type="submit" />
  </form>

  <script type="text/javascript">
    const form = document.getElementById('payment-form');
    
    braintree.dropin.create({
      authorization: 'CLIENT_AUTHORIZATION',
      container: '#dropin-container'
    }, (error, dropinInstance) => {
      if (error) console.error(error);

      form.addEventListener('submit', event => {
        event.preventDefault();

        dropinInstance.requestPaymentMethod((error, payload) => {
          // Send the payment method nonce to your server
        });
      });
    });
  </script>
</body>
```

### Send payment method nonce to server

After obtaining the payment method nonce from Braintree, the last step performed by our client is to send it to the server using a POST request. In the webpage below, this is done on line 27, where we have added the nonce to a hidden field declared on line 9. Finally, the form is submitted to the server on line 28.

`Sending payment method nonce to server`

```html
<head>
  <meta charset="utf-8">
  <script src="https://js.braintreegateway.com/web/dropin/1.29.0/js/dropin.min.js"></script>
</head>
<body>
  <form id="payment-form" action="/route/on/your/server" method="post">
    <div id="dropin-container"></div>
    <input type="submit" />
    <input type="hidden" id="nonce" name="payment_method_nonce"/>
  </form>

  <script type="text/javascript">
    const form = document.getElementById('payment-form');

    braintree.dropin.create({
      authorization: 'CLIENT_AUTHORIZATION',
      container: '#dropin-container'
      }, (error, dropinInstance) => {
        if (error) console.error(error);

        form.addEventListener('submit', event => {
          event.preventDefault();

          dropinInstance.requestPaymentMethod((error, payload) => {
            if (error) console.error(error);

            document.getElementById('nonce').value = payload.nonce;
            form.submit();
          });
        });
      });
  </script>
</body>
```

The server then uses this payment method nonce with a Braintree server SDK to charge a card or update a customer’s payment methods.

# 2. Server Setup for Braintree

The first step of integrating Braintree at our server is to install and configure the Braintree server-side SDK. In this lesson, we will be looking into examples of Python, Node, and Ruby SDKs.

> Note: For Ruby, add the braintree gem to the project’s Gemfile and run bundle install to install it.

### Configuration

Next, we need to configure the Braintree gateway and add the API credentials. We need the following three API keys:

1. Merchant ID

2. Public Key

3. Private Key

> Note: If you haven’t gotten your API keys yet, go through this guide to obtain them from your Braintree sandbox account.

### Configuring Braintree

Pyton

```py
import braintree

gateway = braintree.BraintreeGateway(
    braintree.Configuration(
        braintree.Environment.Sandbox,
        merchant_id="use_your_merchant_id",
        public_key="use_your_public_key",
        private_key="use_your_private_key"
    )
)
```

Node

```js
const braintree = require("braintree");

const gateway = new braintree.BraintreeGateway({
  environment: braintree.Environment.Sandbox,
  merchantId: "useYourMerchantId",
  publicKey: "useYourPublicKey",
  privateKey: "useYourPrivateKey"
});
```

Ruby 

```ruby
gateway = Braintree::Gateway.new(
  :environment => :sandbox,
  :merchant_id => "use_your_merchant_id",
  :public_key => "use_your_public_key",
  :private_key => "use_your_private_key",
)
```




































